<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>สถานศึกษาปลอดภัย - โรงเรียนบางสะพานวิทยา</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script>
        tailwind.config={theme:{extend:{colors:{'school-green':'#1e5631','school-light-green':'#22c55e','school-yellow':'#fbbf24','school-dark-yellow':'#f59e0b','school-accent':'#10b981'},animation:{'fade-in':'fadeIn 0.5s ease-in-out','slide-up':'slideUp 0.6s ease-out',marquee:'marquee 40s linear infinite',spin:'spin 1s linear infinite'},keyframes:{fadeIn:{'0%':{opacity:'0',transform:'translateY(20px)'},'100%':{opacity:'1',transform:'translateY(0)'}},slideUp:{'0%':{opacity:'0',transform:'translateY(30px)'},'100%':{opacity:'1',transform:'translateY(0)'}},marquee:{'0%':{transform:'translateX(100%)'},'100%':{transform:'translateX(-100%)'}},spin:{from:{transform:'rotate(0deg)'},to:{transform:'rotate(360deg)'}}}}}}
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700;800&display=swap');
        body { font-family: 'Sarabun', sans-serif; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); }
        .section-hidden { display: none; }
        .section-active { display: block; animation: fade-in 0.5s ease-in-out; }
        .glass-effect { background: rgba(255, 255, 255, 0.25); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.18); }
        .card-hover:hover { transform: translateY(-8px); box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1); }
        .gradient-text { background: linear-gradient(135deg, #1e5631, #22c55e); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .nav-active { background-image: linear-gradient(to right, var(--tw-gradient-stops)) !important; --tw-gradient-from: #1e5631 !important; --tw-gradient-to: #10b981 !important; color: white !important; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        
        /* --- START: CSS for Lost and Found --- */
        :root { --primary: #1e8449; --primary-dark: #145a32; }
        .lost-found-header { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); }
        .btn-lf-primary { background-color: var(--primary); color: white; transition: all 0.3s; }
        .btn-lf-primary:hover { background-color: var(--primary-dark); }
        .form-input-lf:focus, .form-select-lf:focus { border-color: var(--primary) !important; box-shadow: 0 0 0 3px rgba(30, 132, 73, 0.2); outline:none; }
        .status-badge { display: inline-flex; padding: 0.25rem 0.75rem; font-size: 0.75rem; line-height: 1rem; font-weight: 600; border-radius: 9999px; }
        .status-badge.found { background-color: #d1fae5; color: #065f46; } 
        .status-badge.lost { background-color: #fee2e2; color: #991b1b; } 
        .lf-detail-modal-image { max-height: 20rem; width: auto; margin: 0 auto; border-radius: 0.375rem; border: 1px solid #e5e7eb; }
        /* --- END: CSS for Lost and Found --- */

        .form-error-message { color: #ef4444; font-size: 0.875rem; margin-top: 0.5rem; }
        .form-input-error { border-color: #ef4444 !important; }
        .toast { padding: 1rem 1.5rem; color: white; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); opacity: 0; transform: translateX(100%); transition: all 0.4s ease-in-out; }
        .toast.show { opacity: 1; transform: translateX(0); }
        .toast.success { background-color: #27ae60; }
        .toast.error { background-color: #c0392b; }
    </style>
</head>
<body class="min-h-screen">
    <div id="main-site">
        <div class="bg-gradient-to-r from-red-600 to-red-700 text-white py-2 overflow-hidden">
            <div class="flex items-center">
                <div class="bg-white text-red-600 px-4 py-1 font-bold text-sm rounded-r-full flex-shrink-0 flex items-center gap-2"><i class="fa-solid fa-bullhorn"></i>ข่าวสารล่าสุด</div>
                <div id="news-ticker" class="ml-4 whitespace-nowrap animate-marquee"><span><i class="fa-solid fa-spinner fa-spin mr-2"></i>กำลังโหลดข่าวสาร...</span></div>
            </div>
        </div>
        <header class="relative overflow-hidden bg-gradient-to-br from-school-green via-school-accent to-school-light-green">
            <div class="relative z-10 container mx-auto px-4 py-8">
                <div class="flex items-center space-x-6">
                    <div><img src="LOGO BSPWIT.png" alt="โลโก้โรงเรียน" class="w-40 h-auto mx-auto mb-4" onerror="this.onerror=null; this.src='https://placehold.co/100x100/E2E8F0/4A5568?text=Logo';"></div>
                    <div class="text-white">
                        <h1 class="text-4xl md:text-5xl font-bold mb-2 animate-slide-up">โรงเรียนบางสะพานวิทยา</h1>
                        <p class="text-xl text-green-100 animate-slide-up" style="animation-delay: 0.2s;">ระบบจัดการความปลอดภัยในสถานศึกษา</p>
                    </div>
                </div>
            </div>
        </header>

        <nav id="main-nav" class="sticky top-0 z-50 glass-effect shadow-lg">
            <div class="container mx-auto px-4"><div class="flex flex-wrap justify-center items-center gap-2 py-4">
                <button data-section="home" class="nav-item bg-gradient-to-r from-school-yellow to-school-dark-yellow text-school-green px-6 py-3 rounded-full font-semibold transition-all hover:scale-105 shadow-lg inline-flex items-center gap-2"><i class="fa-solid fa-home"></i>หน้าแรก</button>
                <button data-section="equipment" class="nav-item bg-gradient-to-r from-school-light-green to-school-accent text-white px-6 py-3 rounded-full font-semibold transition-all hover:scale-105 shadow-lg inline-flex items-center gap-2"><i class="fa-solid fa-helmet-safety"></i>อุปกรณ์ความปลอดภัย</button>
                <button data-section="report" class="nav-item bg-gradient-to-r from-blue-500 to-blue-600 text-white px-6 py-3 rounded-full font-semibold transition-all hover:scale-105 shadow-lg inline-flex items-center gap-2"><i class="fa-solid fa-flag"></i>แจ้งปัญหา</button>
                <button data-section="emergency" class="nav-item bg-gradient-to-r from-red-500 to-red-600 text-white px-6 py-3 rounded-full font-semibold transition-all hover:scale-105 shadow-lg animate-pulse inline-flex items-center gap-2"><i class="fa-solid fa-siren-on"></i>แจ้งเหตุด่วน</button>
                <button data-section="videos" class="nav-item bg-gradient-to-r from-purple-500 to-purple-600 text-white px-6 py-3 rounded-full font-semibold transition-all hover:scale-105 shadow-lg inline-flex items-center gap-2"><i class="fa-solid fa-film"></i>วิดีโอความรู้</button>
                <button data-section="lostandfound" class="nav-item bg-gradient-to-r from-gray-500 to-gray-600 text-white px-6 py-3 rounded-full font-semibold transition-all hover:scale-105 shadow-lg inline-flex items-center gap-2"><i class="fa-solid fa-magnifying-glass"></i>Lost & Found</button>
            </div></div>
        </nav>

        <main id="main-content-container" class="container mx-auto px-4 py-8">
            <section id="home" class="section-active">
                 <div class="relative overflow-hidden bg-gradient-to-br from-school-green via-school-accent to-school-light-green rounded-3xl p-8 mb-12 shadow-2xl">
                    <div class="relative z-10 flex flex-col lg:flex-row items-center">
                        <div class="lg:w-2/3 mb-8 lg:mb-0 text-white"><h2 class="text-5xl font-bold mb-6">ยินดีต้อนรับสู่ระบบความปลอดภัย</h2><p class="text-xl text-green-100 mb-8 leading-relaxed">เทคโนโลยีที่ทันสมัย เพื่อสภาพวดล้อมการเรียนรู้ที่ปลอดภัยสำหรับทุกคน</p></div>
                        <div class="lg:w-1/3 flex justify-center"><div class="relative bg-white bg-opacity-20 backdrop-blur-lg rounded-full p-8"><i class="fa-solid fa-shield-heart w-32 h-32 text-white text-8xl flex items-center justify-center"></i></div></div>
                    </div>
                </div>
                <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8 mb-12">
                    <div class="card-hover bg-white rounded-2xl p-8 shadow-xl border border-gray-100"><div class="flex items-center mb-6"><div class="bg-gradient-to-br from-school-light-green to-school-accent p-4 rounded-2xl mr-6 shadow-lg"><i class="fa-solid fa-tasks w-8 h-8 text-white text-3xl"></i></div><h3 class="text-2xl font-bold gradient-text">จัดการอุปกรณ์</h3></div><p class="text-gray-600 text-lg">ตรวจสอบและจัดการอุปกรณ์ความปลอดภัยทั้งหมดในสถานศึกษาด้วยระบบที่ทันสมัย</p></div>
                    <div class="card-hover bg-white rounded-2xl p-8 shadow-xl border border-gray-100"><div class="flex items-center mb-6"><div class="bg-gradient-to-br from-school-yellow to-school-dark-yellow p-4 rounded-2xl mr-6 shadow-lg"><i class="fa-solid fa-flag w-8 h-8 text-white text-3xl"></i></div><h3 class="text-2xl font-bold gradient-text">แจ้งปัญหา</h3></div><p class="text-gray-600 text-lg">รายงานปัญหาความปลอดภัยได้อย่างรวดเร็วและมีประสิทธิภาพผ่านระบบออนไลน์</p></div>
                    <div class="card-hover bg-white rounded-2xl p-8 shadow-xl border border-gray-100 md:col-span-2 lg:col-span-1"><div class="flex items-center mb-6"><div class="bg-gradient-to-br from-red-500 to-red-600 p-4 rounded-2xl mr-6 shadow-lg animate-pulse"><i class="fa-solid fa-triangle-exclamation w-8 h-8 text-white text-3xl"></i></div><h3 class="text-2xl font-bold gradient-text">เหตุฉุกเฉิน</h3></div><p class="text-gray-600 text-lg">แจ้งเหตุฉุกเฉินและสถานการณ์ที่ต้องการความช่วยเหลือทันทีด้วยระบบเตือนภัย</p></div>
                </div>
            </section>

            <section id="equipment" class="section-hidden">
                 <div class="bg-white rounded-3xl shadow-2xl p-8 border border-gray-100">
                    <h2 class="text-4xl font-bold gradient-text mb-8">อุปกรณ์ความปลอดภัย</h2>
                    <div class="overflow-x-auto rounded-2xl shadow-lg">
                        <table class="w-full">
                            <thead><tr class="bg-gradient-to-r from-school-green to-school-accent text-white"><th class="px-6 py-4 text-left font-semibold">อุปกรณ์</th><th class="px-6 py-4 text-left font-semibold">สถานที่</th><th class="px-6 py-4 text-left font-semibold">ตรวจสอบล่าสุด</th><th class="px-6 py-4 text-left font-semibold">ตรวจสอบครั้งถัดไป</th></tr></thead>
                            <tbody id="equipment-table-body" class="bg-white"><tr><td colspan="4" class="text-center p-8 text-gray-500"><i class="fa-solid fa-spinner fa-spin mr-2"></i>กำลังโหลดข้อมูลอุปกรณ์...</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="report" class="section-hidden">
                  <div class="bg-white rounded-3xl shadow-2xl p-8 border border-gray-100">
                    <h2 class="text-4xl font-bold gradient-text mb-8 flex items-center"><div class="bg-gradient-to-br from-blue-500 to-blue-600 p-3 rounded-2xl mr-4"></div>แจ้งปัญหาทั่วไป</h2>
                    <div class="max-w-4xl mx-auto">
                        <form id="reportForm" class="space-y-8" novalidate>
                            <div class="grid md:grid-cols-2 gap-8">
                                <div><h3 class="text-2xl font-bold text-gray-700 mb-4"><i class="fa-solid fa-user mr-3"></i>ข้อมูลผู้แจ้ง</h3>
                                    <div class="space-y-4">
                                        <div><label for="reporterName" class="block text-gray-700 font-semibold mb-2">ชื่อ-นามสกุล *</label><input type="text" id="reporterName" required class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:border-blue-500"><div class="form-error-message"></div></div>
                                        <div><label for="reporterRole" class="block text-gray-700 font-semibold mb-2">ตำแหน่ง *</label><select id="reporterRole" required class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:border-blue-500"><option value="">เลือกตำแหน่ง</option><option value="นักเรียน">นักเรียน</option><option value="ครู">ครู</option><option value="เจ้าหน้าที่">เจ้าหน้าที่</option><option value="ผู้ปกครอง">ผู้ปกครอง</option></select><div class="form-error-message"></div></div>
                                        <div><label for="reporterPhone" class="block text-gray-700 font-semibold mb-2">เบอร์โทรศัพท์ *</label><input type="tel" id="reporterPhone" required class="w-full px-4 py-3 rounded-xl border border-gray-300"></div>
                                    </div>
                                </div>
                                <div><h3 class="text-2xl font-bold text-gray-700 mb-4"><i class="fa-solid fa-triangle-exclamation mr-3"></i>รายละเอียดปัญหา</h3>
                                    <div class="space-y-4">
                                        <div><label for="problemType" class="block text-gray-700 font-semibold mb-2">ประเภทปัญหา *</label><select id="problemType" required class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:border-orange-500"><option value="">เลือกประเภทปัญหา</option><option value="อุปกรณ์ชำรุด">อุปกรณ์ชำรุด</option><option value="ไฟฟ้า/ประปา">ไฟฟ้า/ประปา</option><option value="อาคาร/สถานที่">อาคาร/สถานที่</option><option value="ความสะอาด">ความสะอาด</option><option value="อื่นๆ">อื่นๆ</option></select><div class="form-error-message"></div></div>
                                        <div><label for="location" class="block text-gray-700 font-semibold mb-2">สถานที่เกิดเหตุ *</label><input type="text" id="location" required class="w-full px-4 py-3 rounded-xl border border-gray-300" placeholder="เช่น อาคาร 1 ชั้น 2"><div class="form-error-message"></div></div>
                                        <div><label for="urgency" class="block text-gray-700 font-semibold mb-2">ระดับความเร่งด่วน *</label><select id="urgency" required class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:border-orange-500"><option value="">เลือกระดับ</option><option value="ต่ำ">ต่ำ</option><option value="ปานกลาง">ปานกลาง</option><option value="สูง">สูง</option></select><div class="form-error-message"></div></div>
                                    </div>
                                </div>
                            </div>
                            <div><h3 class="text-2xl font-bold text-gray-700 mb-4"><i class="fa-solid fa-pencil mr-3"></i>คำอธิบายเพิ่มเติม</h3>
                                <div><label for="description" class="block text-gray-700 font-semibold mb-2">อธิบายปัญหาโดยละเอียด *</label><textarea id="description" required rows="4" class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:border-green-500"></textarea><div class="form-error-message"></div></div>
                                <div class="mt-4"><label for="suggestions" class="block text-gray-700 font-semibold mb-2">ข้อเสนอแนะ</label><textarea id="suggestions" rows="3" class="w-full px-4 py-3 rounded-xl border border-gray-300"></textarea></div>
                            </div>
                            <div class="text-center">
                                <button type="submit" class="bg-gradient-to-r from-school-light-green to-school-accent text-white px-12 py-4 rounded-full font-bold text-xl transition-all hover:scale-105 shadow-2xl inline-flex items-center justify-center">
                                    <span class="btn-text inline-flex items-center gap-2"><i class="fa-solid fa-paper-plane"></i>ส่งรายงาน</span>
                                    <svg class="animate-spin h-5 w-5 text-white hidden btn-spinner" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                </button>
                                <p class="text-gray-600 mt-4 text-sm">* ข้อมูลจะถูกส่งไปยังทีมงานเพื่อดำเนินการโดยเร็วที่สุด</p>
                            </div>
                        </form>
                    </div>
                </div>
            </section>
            
            <section id="emergency" class="section-hidden">
                 <div class="bg-white rounded-3xl shadow-2xl p-8 border border-gray-100">
                    <h2 class="text-4xl font-bold text-red-600 mb-4 flex items-center">
                        <div class="bg-gradient-to-br from-red-500 to-red-600 p-3 rounded-2xl mr-4 animate-pulse">
                            <i class="fa-solid fa-triangle-exclamation w-8 h-8 text-white"></i>
                        </div>
                        แจ้งเหตุฉุกเฉิน
                    </h2>
                    <p class="text-gray-600 text-lg mb-8 max-w-4xl mx-auto">
                        <span class="font-semibold">โปรดใช้ในกรณีฉุกเฉินจริงเท่านั้น</span> การแจ้งเหตุจะถูกส่งไปยังผู้ดูแลระบบโดยตรงและทันที
                    </p>
                    <div class="max-w-4xl mx-auto">
                        <form id="emergencyForm" class="space-y-6" novalidate>
                            <div class="grid md:grid-cols-2 gap-6">
                                <div>
                                    <label for="emergencyReporterName" class="block text-gray-700 font-semibold mb-2">ชื่อ-นามสกุล ผู้แจ้ง *</label>
                                    <input type="text" id="emergencyReporterName" required class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:border-red-500">
                                    <div class="form-error-message"></div>
                                </div>
                                <div>
                                    <label for="emergencyReporterRole" class="block text-gray-700 font-semibold mb-2">ตำแหน่ง *</label>
                                    <select id="emergencyReporterRole" required class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:border-red-500">
                                        <option value="">เลือกตำแหน่ง</option>
                                        <option value="นักเรียน">นักเรียน</option>
                                        <option value="ครู">ครู</option>
                                        <option value="เจ้าหน้าที่">เจ้าหน้าที่</option>
                                        <option value="ผู้ปกครอง">ผู้ปกครอง</option>
                                    </select>
                                    <div class="form-error-message"></div>
                                </div>
                                <div>
                                    <label for="emergencyType" class="block text-gray-700 font-semibold mb-2">ประเภทเหตุฉุกเฉิน *</label>
                                    <select id="emergencyType" required class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:border-red-500">
                                        <option value="">เลือกประเภทเหตุ</option>
                                        <option value="เพลิงไหม้">เพลิงไหม้</option>
                                        <option value="ทะเลาะวิวาท">ทะเลาะวิวาท</option>
                                        <option value="อุบัติเหตุ">อุบัติเหตุ</option>
                                        <option value="บุคคลภายนอกบุกรุก">บุคคลภายนอกบุกรุก</option>
                                        <option value="อื่นๆ">อื่นๆ</option>
                                    </select>
                                    <div class="form-error-message"></div>
                                </div>
                                <div>
                                    <label for="emergencyLocation" class="block text-gray-700 font-semibold mb-2">สถานที่เกิดเหตุ *</label>
                                    <input type="text" id="emergencyLocation" required class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:border-red-500" placeholder="ระบุให้ชัดเจนที่สุด">
                                    <div class="form-error-message"></div>
                                </div>
                            </div>
                            <div>
                                <label for="emergencyDescription" class="block text-gray-700 font-semibold mb-2">อธิบายสถานการณ์โดยละเอียด *</label>
                                <textarea id="emergencyDescription" required rows="4" class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:border-red-500" placeholder="เกิดอะไรขึ้น มีใครเกี่ยวข้องบ้าง ต้องการความช่วยเหลืออะไรด่วนที่สุด"></textarea>
                                <div class="form-error-message"></div>
                            </div>
                            <div>
                                <label for="emergencyFile" class="block text-gray-700 font-semibold mb-2">แนบไฟล์รูปภาพ/วิดีโอ (ถ้ามี)</label>
                                <input type="file" id="emergencyFile" class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-red-50 file:text-red-700 hover:file:bg-red-100">
                                <p class="text-xs text-gray-500 mt-1">ขนาดไฟล์ไม่เกิน 5MB</p>
                            </div>
                            <div class="text-center pt-4">
                                <button type="submit" class="bg-gradient-to-r from-red-500 to-red-700 text-white px-12 py-4 rounded-full font-bold text-xl transition-all hover:scale-105 shadow-2xl inline-flex items-center justify-center animate-pulse hover:animate-none">
                                    <span class="btn-text inline-flex items-center gap-3"><i class="fa-solid fa-siren-on"></i>ส่งเรื่องด่วนทันที</span>
                                    <svg class="animate-spin h-6 w-6 text-white hidden btn-spinner" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </section>

            <section id="videos" class="section-hidden">
                <div class="bg-white rounded-3xl shadow-2xl p-8 border border-gray-100">
                    <h2 class="text-4xl font-bold gradient-text mb-8">วิดีโอความรู้ด้านความปลอดภัย</h2>
                    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
                        <div class="card-hover bg-white rounded-2xl overflow-hidden shadow-xl border">
                            <div class="aspect-video bg-red-400 flex items-center justify-center relative"><i class="fa-solid fa-play text-5xl text-white z-10"></i><div class="absolute inset-0 bg-black opacity-20"></div></div>
                            <div class="p-6">
                                <h3 class="font-bold text-xl gradient-text mb-3">การป้องกันเพลิงไหม้</h3>
                                <p class="text-gray-600 mb-4">เรียนรู้วิธีการป้องกันและรับมือเหตุเพลิงไหม้</p>
                                <button data-video="fire" class="w-full bg-gradient-to-r from-school-yellow to-school-dark-yellow text-white px-6 py-3 rounded-full font-semibold hover:scale-105 transition-transform">
                                    <i class="fa-solid fa-play mr-2"></i>เข้าอบรมและทดสอบ
                                </button>
                            </div>
                        </div>
                        <div class="card-hover bg-white rounded-2xl overflow-hidden shadow-xl border">
                            <div class="aspect-video bg-blue-400 flex items-center justify-center relative"><i class="fa-solid fa-play text-5xl text-white z-10"></i><div class="absolute inset-0 bg-black opacity-20"></div></div>
                            <div class="p-6">
                                <h3 class="font-bold text-xl gradient-text mb-3">การรับมือแผ่นดินไหว</h3>
                                <p class="text-gray-600 mb-4">เรียนรู้วิธีการปฏิบัติตนเมื่อเกิดเหตุแผ่นดินไหว</p>
                                <button data-video="earthquake" class="w-full bg-gradient-to-r from-school-yellow to-school-dark-yellow text-white px-6 py-3 rounded-full font-semibold hover:scale-105 transition-transform">
                                    <i class="fa-solid fa-play mr-2"></i>เข้าอบรมและทดสอบ
                                </button>
                            </div>
                        </div>
                        <div class="card-hover bg-white rounded-2xl overflow-hidden shadow-xl border">
                            <div class="aspect-video bg-yellow-400 flex items-center justify-center relative"><i class="fa-solid fa-play text-5xl text-white z-10"></i><div class="absolute inset-0 bg-black opacity-20"></div></div>
                            <div class="p-6">
                                <h3 class="font-bold text-xl gradient-text mb-3">อุบัติเหตุบนรถบัส</h3>
                                <p class="text-gray-600 mb-4">เรียนรู้วิธีการรับมือเมื่อเกิดอุบัติเหตุบนรถโดยสาร</p>
                                <button data-video="bus_accident" class="w-full bg-gradient-to-r from-school-yellow to-school-dark-yellow text-white px-6 py-3 rounded-full font-semibold hover:scale-105 transition-transform">
                                    <i class="fa-solid fa-play mr-2"></i>เข้าอบรมและทดสอบ
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            
            <section id="lostandfound" class="section-hidden">
                <header class="lost-found-header text-white shadow-lg rounded-t-2xl">
                    <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-4 flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <img src="https://img2.pic.in.th/pic/-----------Facebook.png" alt="โลโก้สภานักเรียน" class="h-14" onerror="this.onerror=null; this.src='https://placehold.co/56x56/E2E8F0/4A5568?text=Logo';">
                            <div>
                                <h1 class="text-2xl font-bold">SAPA Lost and Found</h1>
                                <p class="text-sm opacity-90">คณะกรรมการสภานักเรียนโรงเรียนบางสะพานวิทยา</p>
                            </div>
                        </div>
                        <a href="https://sapa-lost-and-found.vercel.app/" target="_blank" class="btn-lf-primary px-4 py-2 rounded-md font-medium">
                            <i class="fas fa-sign-in-alt mr-2"></i>เข้าสู่ระบบสำหรับเจ้าหน้าที่
                        </a>
                    </div>
                </header>

                <main class="flex-grow container mx-auto px-4 sm:px-6 lg:px-8 py-8">
                    <div class="bg-white rounded-b-2xl shadow-xl p-6 sm:p-8">
                        <h2 class="text-3xl font-bold text-gray-800 mb-8">รายการของทั้งหมด</h2>
                        <div class="mb-6">
                            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                                <div class="flex-grow">
                                    <input type="text" id="lf_searchInput" placeholder="ค้นหาด้วยรายละเอียด, ประเภท, สถานที่..." class="form-input-lf w-full px-4 py-2 border border-gray-300 rounded-md">
                                </div>
                                <div class="flex space-x-2">
                                    <select id="lf_reportTypeFilter" class="form-select-lf px-4 py-2 border border-gray-300 rounded-md">
                                        <option value="all">ของทั้งหมด (แจ้งพบ/แจ้งหาย)</option>
                                        <option value="found">ของที่พบ (รอรับคืน)</option>
                                        <option value="lost">ของที่แจ้งหาย (ยังไม่พบ)</option>
                                    </select>
                                    <button id="lf_searchBtn" class="btn-lf-primary px-4 py-2 rounded-md">ค้นหา</button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ประเภทรายงาน</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ประเภทของ</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">รายละเอียด</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">สถานที่</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">วันที่แจ้ง</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">สถานะ</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">จัดการ</th>
                                    </tr>
                                </thead>
                                <tbody id="lf_itemsTableBody" class="bg-white divide-y divide-gray-200"></tbody>
                            </table>
                            <p id="lf_loadingMessage" class="text-center text-gray-500 py-4">กำลังโหลดข้อมูล...</p>
                            <p id="lf_noResultsMessage" class="text-center text-gray-500 py-4 hidden">ไม่พบข้อมูล</p>
                        </div>
                    </div>
                </main>
            </section>

        </main>
        
        <footer class="bg-gradient-to-br from-school-green via-school-accent to-school-light-green text-white py-12 mt-16">
            <div class="container mx-auto px-4 flex flex-col md:flex-row justify-between items-center text-center md:text-left">
    
                <div class="mb-6 md:mb-0">
                    <h3 class="text-xl font-bold mb-3 text-green-100">ช่องทางการติดต่อ</h3>
                    <div class="space-y-2 text-green-200">
                        <p class="flex items-center justify-center md:justify-start">
                            <i class="fas fa-phone-alt w-5 mr-2"></i>
                            <span>032-691-190 (เบอร์โทรศัพท์โรงเรียน)</span>
                        </p>
                        <p class="flex items-center justify-center md:justify-start">
                            <i class="fab fa-facebook w-5 mr-2"></i>
                            <a href="https://www.facebook.com/bspwit" target="_blank" class="hover:underline">Facebook โรงเรียนบางสะพานวิทยา</a>
                        </p>
                        <p class="flex items-start justify-center md:justify-start">
                            <i class="fas fa-map-marker-alt w-5 mr-2 mt-1"></i>
                            <span>เลขที่ 6 หมู่ที่ 6 ตำบลกำเนิดนพคุณ อำเภอบางสะพาน จังหวัดประจวบคีรีขันธ์</span>
                        </p>
                    </div>
                </div>
    
                <div class="md:text-right">
                    <p class="text-green-100 text-lg">&copy; <span id="current-year"></span> <span class="font-bold">โรงเรียนบางสะพานวิทยา</span></p>
                    <p class="text-green-200 text-sm mt-2">ระบบจัดการความปลอดภัยในสถานศึกษา</p>
                </div>
    
            </div>
        </footer>
    </div>

    <div id="toast-container" class="fixed top-5 right-5 z-50 space-y-2"></div>
    
    <div id="lf_itemDetailModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-[100] transition-opacity duration-300 ease-in-out">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6 pb-3 border-b">
                    <h3 class="text-2xl font-bold text-gray-800">รายละเอียดของ</h3>
                    <button id="lf_closeDetailModal" class="text-gray-500 hover:text-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>
                <div id="lf_modalDetailContent" class="space-y-5"></div>
                <div class="border-t pt-4 mt-6 flex justify-end">
                    <button id="lf_closeDetailModalBtn" class="bg-gray-200 text-gray-700 px-5 py-2 rounded-md hover:bg-gray-300">ปิด</button>
                </div>
            </div>
        </div>
    </div>

    <div id="training-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden p-4">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 id="training-modal-title" class="text-xl font-bold">อบรมความปลอดภัย</h3>
                <button id="close-training-modal-btn" class="text-gray-500 hover:text-gray-700 text-3xl leading-none">&times;</button>
            </div>
    
            <div class="overflow-y-auto p-6">
                <div id="stage-video">
                    <div id="video-embed-container" class="aspect-video mb-4 bg-black"></div>
                    <button id="start-quiz-btn" class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition-colors">ดูวิดีโอจบแล้ว, เริ่มทำแบบทดสอบ</button>
                </div>
    
                <div id="stage-user-info" class="hidden">
                    <h4 class="text-lg font-semibold mb-4">กรุณากรอกข้อมูลเพื่อรับเกียรติบัตร</h4>
                    <form id="user-info-form" class="space-y-4">
                        <div>
                            <label for="traineeName" class="block mb-1 font-medium text-gray-700">ชื่อ-นามสกุล (สำหรับระบุในเกียรติบัตร) *</label>
                            <input type="text" id="traineeName" required class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="traineeEmail" class="block mb-1 font-medium text-gray-700">อีเมล (สำหรับจัดส่งเกียรติบัตร) *</label>
                            <input type="email" id="traineeEmail" required class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                        </div>
                        <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors">ดำเนินการต่อ</button>
                    </form>
                </div>
                
                <div id="stage-quiz" class="hidden">
                    <h4 class="text-lg font-semibold mb-4">แบบทดสอบหลังการอบรม</h4>
                    <form id="quiz-form" class="space-y-6"></form>
                    <button id="submit-quiz-btn" class="w-full mt-6 bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors">ส่งคำตอบ</button>
                </div>
    
                <div id="stage-result" class="hidden text-center py-8">
                    <div id="result-icon" class="text-6xl mb-4"></div>
                    <h4 id="result-title" class="text-2xl font-bold mb-2"></h4>
                    <p id="result-message" class="text-gray-600"></p>
                </div>
            </div>
        </div>
    </div>
    
    <script>
document.addEventListener('DOMContentLoaded', function() {
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxRuhZt-OxUsU23t8eTtNiqJKVMazsFEm-iIXhSq9yzf5grGDzcQ-wvm9TsQxL-S0qL/exec';
    
    // --- Main App Logic ---
    const App = {
        init() {
            this.navButtons = document.querySelectorAll('#main-nav button[data-section]');
            this.sections = document.querySelectorAll('main section');
            this.form = document.getElementById('reportForm');
            this.emergencyForm = document.getElementById('emergencyForm');
            this.mainContentContainer = document.getElementById('main-content-container');
            
            // Note: The training modal handles its own video, this is for the old modal if you re-add it.
            // this.videoModal = document.getElementById('video-modal'); 
            // this.videoEmbedContainer = document.getElementById('video-embed-container');
            // this.closeModalBtn = document.getElementById('close-modal-btn');
            
            this.setupEventListeners();
            this.updateCopyrightYear();
            this.showSection('home', false);
            this.fetchAndDisplayNews();
            this.fetchAndDisplayEquipment();
        },
        setupEventListeners() {
            document.body.addEventListener('click', e => {
                const sectionButton = e.target.closest('button[data-section]');
                if (sectionButton) this.showSection(sectionButton.dataset.section);
                
                const videoButton = e.target.closest('button[data-video]');
                if (videoButton) this.playVideo(videoButton.dataset.video);
            });
            this.form?.addEventListener('submit', this.handleFormSubmit.bind(this));
            this.emergencyForm?.addEventListener('submit', this.handleEmergencySubmit.bind(this));
            
            // if(this.closeModalBtn) {
            //     this.closeModalBtn.addEventListener('click', () => {
            //         this.videoModal.classList.add('hidden');
            //         this.videoEmbedContainer.innerHTML = '';
            //     });
            // }
        },
        async fetchAndDisplayNews() {
            try {
                const response = await fetch(`${SCRIPT_URL}?action=getNews`);
                const news = await response.json();
                const ticker = document.getElementById('news-ticker');
                if (ticker && news.length > 0) {
                    ticker.innerHTML = news.map(item => `<span class="mx-8"><i class="fa-solid fa-bullhorn mr-2"></i>${item.title}: ${item.content}</span>`).join('');
                } else if (ticker) {
                    ticker.innerHTML = '<span><i class="fa-solid fa-check-circle mr-2"></i>ขณะนี้ยังไม่มีข่าวสารใหม่</span>';
                }
            } catch (error) {
                console.error("Error fetching news:", error);
                const ticker = document.getElementById('news-ticker');
                if (ticker) ticker.innerHTML = '<span><i class="fa-solid fa-times-circle mr-2"></i>เกิดข้อผิดพลาดในการโหลดข่าวสาร</span>';
            }
        },
        async fetchAndDisplayEquipment() {
            try {
                const response = await fetch(`${SCRIPT_URL}?action=getEquipment`);
                const equipment = await response.json();
                const tableBody = document.getElementById('equipment-table-body');
                if (tableBody) {
                    if (equipment.length > 0) {
                        tableBody.innerHTML = equipment.map(item => `
                            <tr class="border-b border-gray-100 hover:bg-gray-50">
                                <td class="px-6 py-4 font-medium">${item.name}</td>
                                <td class="px-6 py-4 text-gray-600">${item.location}</td>
                                <td class="px-6 py-4 text-gray-600">${item.lastChecked ? new Date(item.lastChecked).toLocaleDateString('th-TH') : '-'}</td>
                                <td class="px-6 py-4 text-gray-600">${item.nextCheck ? new Date(item.nextCheck).toLocaleDateString('th-TH') : '-'}</td>
                            </tr>`).join('');
                    } else {
                        tableBody.innerHTML = `<tr><td colspan="4" class="text-center p-8 text-gray-500">ยังไม่มีข้อมูลอุปกรณ์ในระบบ</td></tr>`;
                    }
                }
            } catch (error) { 
                console.error("Error fetching equipment:", error); 
                const tableBody = document.getElementById('equipment-table-body');
                if(tableBody) tableBody.innerHTML = `<tr><td colspan="4" class="text-center p-8 text-red-500">เกิดข้อผิดพลาดในการโหลดข้อมูลอุปกรณ์</td></tr>`;
            }
        },
        showSection(sectionId, shouldScroll = true) {
            this.sections.forEach(s => s.classList.replace('section-active', 'section-hidden'));
            const targetSection = document.getElementById(sectionId);
            if (targetSection) targetSection.classList.replace('section-hidden', 'section-active');
            this.navButtons.forEach(b => b.classList.remove('nav-active'));
            const activeButton = document.querySelector(`button[data-section="${sectionId}"]`);
            if(activeButton) activeButton.classList.add('nav-active');
            if (shouldScroll) this.mainContentContainer.scrollIntoView({ behavior: 'smooth' });
            // If Lost and Found section is shown, initialize it
            if (sectionId === 'lostandfound' && typeof LostAndFoundApp.init === 'function' && !LostAndFoundApp.initialized) {
                LostAndFoundApp.init();
            }
        },
        showToast(message, type = 'success', duration = 3000) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => { toast.classList.remove('show'); toast.addEventListener('transitionend', () => toast.remove()); }, duration);
        },
        playVideo(videoId) {
            // This function is now handled by the training/quiz logic below
            console.log("Starting training for video:", videoId);
        },
        updateCopyrightYear() {
            const yearEl = document.getElementById('current-year');
            if (yearEl) yearEl.textContent = new Date().getFullYear() + 543;
        },
        async handleEmergencySubmit(e) {
            e.preventDefault();
            if (!this.validateForm(this.emergencyForm)) return;
            
            const submitBtn = this.emergencyForm.querySelector('button[type="submit"]'), btnText = submitBtn.querySelector('.btn-text'), btnSpinner = submitBtn.querySelector('.btn-spinner');
            submitBtn.disabled = true, btnText.classList.add('hidden'), btnSpinner.classList.remove('hidden');

            const fileInput = document.getElementById('emergencyFile');
            const file = fileInput.files[0];
            let fileData = {};

            if (file) {
                if (file.size > 5 * 1024 * 1024) { // 5MB limit
                    this.showToast('❌ ขนาดไฟล์ต้องไม่เกิน 5MB', 'error');
                    submitBtn.disabled = false, btnText.classList.remove('hidden'), btnSpinner.classList.add('hidden');
                    return;
                }
                try {
                    const base64 = await this.toBase64(file);
                    fileData = { fileData: base64, fileName: file.name, mimeType: file.type };
                } catch (error) {
                    this.showToast('❌ เกิดข้อผิดพลาดในการอ่านไฟล์', 'error');
                    submitBtn.disabled = false, btnText.classList.remove('hidden'), btnSpinner.classList.add('hidden');
                    return;
                }
            }

            const reportData = {
                reporterName: document.getElementById('emergencyReporterName').value,
                reporterRole: document.getElementById('emergencyReporterRole').value,
                emergencyType: document.getElementById('emergencyType').value,
                location: document.getElementById('emergencyLocation').value,
                description: document.getElementById('emergencyDescription').value,
                ...fileData
            };

            try {
                const response = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'addEmergencyReport', data: reportData }) });
                const result = await response.json();
                if (result.status !== 'success') throw new Error(result.message);
                this.showToast('✅ ส่งรายงานฉุกเฉินสำเร็จ!', 'success'), this.emergencyForm.reset(), this.clearFormErrors(this.emergencyForm);
            } catch (error) { this.showToast(`❌ เกิดข้อผิดพลาด: ${error.message}`, 'error');
            } finally { submitBtn.disabled = false, btnText.classList.remove('hidden'), btnSpinner.classList.add('hidden'); }
        },
        async handleFormSubmit(e) {
            e.preventDefault();
            if (!this.validateForm(this.form)) return;
            const submitBtn = this.form.querySelector('button[type="submit"]'), btnText = submitBtn.querySelector('.btn-text'), btnSpinner = submitBtn.querySelector('.btn-spinner');
            submitBtn.disabled = true, btnText.classList.add('hidden'), btnSpinner.classList.remove('hidden');
            const reportData = { name: document.getElementById('reporterName').value, role: document.getElementById('reporterRole').value, phone: document.getElementById('reporterPhone').value, problemType: document.getElementById('problemType').value, location: document.getElementById('location').value, urgency: document.getElementById('urgency').value, description: document.getElementById('description').value, suggestions: document.getElementById('suggestions').value, };
            try {
                const response = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'addReport', data: reportData }) });
                const result = await response.json();
                if (result.status !== 'success') throw new Error(result.message);
                this.showToast('✅ ส่งรายงานสำเร็จ!', 'success'), this.form.reset(), this.clearFormErrors(this.form);
            } catch (error) { this.showToast(`❌ เกิดข้อผิดพลาด: ${error.message}`, 'error');
            } finally { submitBtn.disabled = false, btnText.classList.remove('hidden'), btnSpinner.classList.add('hidden'); }
        },
        validateForm(formElement) { 
            let isValid = true; 
            this.clearFormErrors(formElement); 
            formElement.querySelectorAll('[required]').forEach(field => { if (!field.value.trim()) { isValid = false, this.showFormError(field, 'กรุณากรอกข้อมูลในช่องนี้'); } }); 
            return isValid; 
        },
        showFormError(field, message) { field.classList.add('form-input-error'); const errorContainer = field.nextElementSibling; if (errorContainer && errorContainer.classList.contains('form-error-message')) { errorContainer.textContent = message; } },
        clearFormErrors(formElement) { 
            formElement.querySelectorAll('.form-input-error').forEach(f => f.classList.remove('form-input-error')); 
            formElement.querySelectorAll('.form-error-message').forEach(el => el.textContent = ''); 
        },
        toBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }
    };

    // --- Lost and Found App Logic ---
    const LostAndFoundApp = {
        initialized: false,
        allFetchedItems: [],
        
        init() {
            this.APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxMlReHBWsB9iGevSQG4-0kiBjn1zbBjG1a_bPWb1yg7nms1CMUrGkHxOpKtttHHZFNCA/exec';
            
            this.elements = {
                tableBody: document.getElementById('lf_itemsTableBody'),
                detailModal: document.getElementById('lf_itemDetailModal'),
                closeDetailModal: document.getElementById('lf_closeDetailModal'),
                closeDetailModalBtn: document.getElementById('lf_closeDetailModalBtn'),
                modalDetailContent: document.getElementById('lf_modalDetailContent'),
                loadingMessage: document.getElementById('lf_loadingMessage'),
                noResultsMessage: document.getElementById('lf_noResultsMessage'),
                searchInput: document.getElementById('lf_searchInput'),
                reportTypeFilter: document.getElementById('lf_reportTypeFilter'),
                searchBtn: document.getElementById('lf_searchBtn'),
            };
            
            this.addEventListeners();
            this.fetchItems();
            this.initialized = true;
        },
        
        addEventListeners() {
            this.elements.searchBtn.addEventListener('click', () => this.fetchItems()); 
            this.elements.searchInput.addEventListener('input', () => this.filterAndSearchItems()); 
            this.elements.reportTypeFilter.addEventListener('change', () => this.fetchItems());
            
            this.elements.closeDetailModal.addEventListener('click', () => this.elements.detailModal.classList.add('hidden'));
            this.elements.closeDetailModalBtn.addEventListener('click', () => this.elements.detailModal.classList.add('hidden'));
        },

        getStatusBadge(status, reportType) {
            let badgeClass = 'status-badge default';
            let statusText = status; 
            if (reportType === 'found') {
                if (status === 'awaiting_claim') { badgeClass = 'status-badge found'; statusText = 'รอรับคืน';}
            } else if (reportType === 'lost') {
                if (status === 'actively_lost') { badgeClass = 'status-badge lost'; statusText = 'แจ้งหาย'; }
            }
            return `<span class="${badgeClass}">${statusText}</span>`;
        },

        renderItems(itemsToRender) {
            const { tableBody, noResultsMessage } = this.elements;
            if(!tableBody || !noResultsMessage) return;

            tableBody.innerHTML = ''; 
            if (itemsToRender.length === 0) {
                noResultsMessage.classList.remove('hidden');
                return;
            }
            noResultsMessage.classList.add('hidden');

            itemsToRender.forEach(item => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm font-medium ${item.reportType === 'lost' ? 'text-red-600' : 'text-green-600'}">${item.reportType === 'lost' ? 'แจ้งหาย' : 'แจ้งพบ'}</div></td>
                    <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm font-medium text-gray-900">${item.itemType || '-'}</div></td>
                    <td class="px-6 py-4"><div class="text-sm text-gray-900 truncate max-w-xs" title="${item.description || ''}">${item.description || '-'}</div></td>
                    <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm text-gray-900">${item.location || '-'}</div></td>
                    <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm text-gray-900">${item.dateReportedSystem || '-'}</div></td>
                    <td class="px-6 py-4 whitespace-nowrap">${this.getStatusBadge(item.status, item.reportType)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button class="view-detail-btn text-indigo-600 hover:text-indigo-900" data-id="${item.itemId}" data-type="${item.reportType}">ดูรายละเอียด</button>
                    </td>
                `;
            });
            this.addEventListenersToTableButtons();
        },

        addEventListenersToTableButtons() {
            this.elements.tableBody.querySelectorAll('.view-detail-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const itemId = e.target.dataset.id;
                    const itemType = e.target.dataset.type;
                    this.showItemDetail(itemId, itemType);
                });
            });
        },
        
        async showItemDetail(itemId, itemType) {
            try {
                this.showLoading();
                const response = await fetch(`${this.APPS_SCRIPT_URL}?action=getItemDetails&itemId=${itemId}&itemType=${itemType}`);
                const result = await response.json();
                this.hideLoading();
                if (result.status === 'success' && result.item) {
                    this.showItemDetailModal(result.item);
                } else {
                    alert('ไม่สามารถโหลดรายละเอียดได้: ' + result.message);
                }
            } catch (error) {
                this.hideLoading();
                alert('เกิดข้อผิดพลาดในการเชื่อมต่อเพื่อดูรายละเอียด');
                console.error("Error fetching item details:", error);
            }
        },

        showItemDetailModal(item) {
            const { modalDetailContent, detailModal } = this.elements;
            if (!item || !modalDetailContent || !detailModal) return;
            
            let detailsHtml = `<div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">`;
            detailsHtml += `<div><h4 class="text-sm font-medium text-gray-500 mb-1">รหัสรายการ</h4><p class="text-gray-900 text-lg">${item.reportType === 'found' ? item.foundItemId : item.lostItemId}</p></div>`;
            detailsHtml += `<div><h4 class="text-sm font-medium text-gray-500 mb-1">ประเภทรายงาน</h4><p class="text-gray-900 text-lg">${item.reportType === 'found' ? 'แจ้งพบ' : 'แจ้งหาย'}</p></div>`;
            detailsHtml += `<div class="md:col-span-2"><h4 class="text-sm font-medium text-gray-500 mb-1">ประเภทของ</h4><p class="text-gray-900">${item.itemType || '-'}</p></div>`;
            detailsHtml += `<div class="md:col-span-2"><h4 class="text-sm font-medium text-gray-500 mb-1">รายละเอียด</h4><p class="text-gray-900 whitespace-pre-wrap">${item.itemDescription || '-'}</p></div>`;
            detailsHtml += `<div><h4 class="text-sm font-medium text-gray-500 mb-1">สถานที่${item.reportType === 'found' ? 'พบ' : 'ทำหาย'}</h4><p class="text-gray-900">${item.reportType === 'found' ? item.locationFound : item.locationLost || '-'}</p></div>`;
            detailsHtml += `<div><h4 class="text-sm font-medium text-gray-500 mb-1">วันที่${item.reportType === 'found' ? 'พบ' : 'ทำหาย'}</h4><p class="text-gray-900">${item.reportType === 'found' ? (item.dateFound || '-') : (item.dateLost || '-')}</p></div>`;
            if (item.reportType === 'found' && item.imageUrl) { 
                detailsHtml += `<div class="md:col-span-2"><h4 class="text-sm font-medium text-gray-500 mb-1">รูปภาพ</h4><img src="${item.imageUrl}" alt="${item.itemType || 'Item Image'}" class="lf-detail-modal-image" onerror="this.style.display='none';"></div>`;
            }
            detailsHtml += `</div>`;

            modalDetailContent.innerHTML = detailsHtml;
            detailModal.classList.remove('hidden');
        },

        async fetchItems() {
            this.showLoading();
            const selectedReportType = this.elements.reportTypeFilter.value;
            try {
                const response = await fetch(`${this.APPS_SCRIPT_URL}?action=getItems&type=${selectedReportType}`);
                const result = await response.json();
                if (result.status === "success" && result.items) {
                    this.allFetchedItems = result.items;
                    this.filterAndSearchItems(); 
                } else {
                    this.elements.noResultsMessage.textContent = "ไม่สามารถโหลดข้อมูลได้: " + (result.message || "ข้อผิดพลาดที่ไม่รู้จัก");
                    this.elements.noResultsMessage.classList.remove('hidden');
                }
            } catch (error) {
                console.error("Fetch items error:", error);
                this.elements.noResultsMessage.textContent = "เกิดข้อผิดพลาดในการเชื่อมต่อเพื่อโหลดข้อมูล";
                this.elements.noResultsMessage.classList.remove('hidden');
            } finally {
                this.hideLoading();
            }
        },

        filterAndSearchItems() {
            const searchTerm = this.elements.searchInput.value.toLowerCase();
            let itemsToDisplay = this.allFetchedItems;

            if (searchTerm) {
                itemsToDisplay = this.allFetchedItems.filter(item => 
                    (item.itemType && item.itemType.toLowerCase().includes(searchTerm)) ||
                    (item.description && item.description.toLowerCase().includes(searchTerm)) ||
                    (item.location && item.location.toLowerCase().includes(searchTerm)) ||
                    (item.itemId && item.itemId.toString().includes(searchTerm))
                );
            }
            this.renderItems(itemsToDisplay);
        },

        showLoading() {
            this.elements.loadingMessage.classList.remove('hidden');
            this.elements.tableBody.innerHTML = '';
            this.elements.noResultsMessage.classList.add('hidden');
        },
        hideLoading() {
            this.elements.loadingMessage.classList.add('hidden');
        }
    };

    // --- Training/Quiz Logic ---
    const trainingModal = document.getElementById('training-modal');
    const closeTrainingModalBtn = document.getElementById('close-training-modal-btn');
    let currentVideoId = null;
    let quizQuestions = [];

    const stageVideo = document.getElementById('stage-video');
    const stageUserInfo = document.getElementById('stage-user-info');
    const stageQuiz = document.getElementById('stage-quiz');
    const stageResult = document.getElementById('stage-result');

    App.playVideo = async function(videoId) {
        currentVideoId = videoId;
        
        stageVideo.style.display = 'block';
        stageUserInfo.style.display = 'none';
        stageQuiz.style.display = 'none';
        stageResult.style.display = 'none';
        document.getElementById('user-info-form').reset();
        
        const trainingData = {
            fire: {
                link: 'https://www.youtube.com/embed/neGqyQ9-c1A?si=XKaR1hqVjK_dXJFS',
                title: 'อบรมความปลอดภัย: การป้องกันและรับมือเหตุเพลิงไหม้'
            },
            earthquake: {
                link: 'https://www.youtube.com/embed/C0034x_b_iM',
                title: 'อบรมความปลอดภัย: การรับมือเหตุแผ่นดินไหว'
            },
            bus_accident: {
                link: 'https://www.youtube.com/embed/your_video_id_here',
                title: 'อบรมความปลอดภัย: การรับมืออุบัติเหตุบนรถโดยสาร'
            }
        };

        const currentTraining = trainingData[videoId];
        if (currentTraining) {
            document.getElementById('training-modal-title').textContent = currentTraining.title;
            document.getElementById('video-embed-container').innerHTML = `<iframe class="w-full h-full" src="${currentTraining.link}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
            trainingModal.classList.remove('hidden');
        }

        try {
            const response = await fetch(`${SCRIPT_URL}?action=getQuizQuestions&videoId=${videoId}`);
            quizQuestions = await response.json();
            document.getElementById('start-quiz-btn').disabled = quizQuestions.length === 0;
        } catch(e) {
            console.error("Failed to fetch quiz questions", e);
            document.getElementById('start-quiz-btn').disabled = true;
        }
    };

    closeTrainingModalBtn.addEventListener('click', () => {
        trainingModal.classList.add('hidden');
        document.getElementById('video-embed-container').innerHTML = '';
    });

    document.getElementById('start-quiz-btn').addEventListener('click', () => {
        stageVideo.style.display = 'none';
        stageUserInfo.style.display = 'block';
    });

    document.getElementById('user-info-form').addEventListener('submit', (e) => {
        e.preventDefault();
        stageUserInfo.style.display = 'none';
        displayQuiz();
        stageQuiz.style.display = 'block';
    });

    function displayQuiz() {
        const quizForm = document.getElementById('quiz-form');
        quizForm.innerHTML = '';
        quizQuestions.forEach((q, index) => {
            const questionDiv = document.createElement('div');
            questionDiv.innerHTML = `
                <p class="font-semibold">${index + 1}. ${q.question}</p>
                <div class="mt-2 space-y-1 pl-4">
                    <div><label class="flex items-center"><input type="radio" name="q${index}" value="A" required class="mr-2">${q.optionA}</label></div>
                    <div><label class="flex items-center"><input type="radio" name="q${index}" value="B" class="mr-2">${q.optionB}</label></div>
                    <div><label class="flex items-center"><input type="radio" name="q${index}" value="C" class="mr-2">${q.optionC}</label></div>
                </div>
            `;
            quizForm.appendChild(questionDiv);
        });
    }

    document.getElementById('submit-quiz-btn').addEventListener('click', async () => {
        const quizForm = document.getElementById('quiz-form');
        if (!quizForm.checkValidity()) {
            App.showToast('กรุณาตอบคำถามให้ครบทุกข้อ', 'error');
            return;
        }

        const answers = [];
        quizQuestions.forEach((q, index) => {
            const selected = quizForm.querySelector(`input[name="q${index}"]:checked`);
            answers.push(selected ? selected.value : null);
        });
        
        const payload = {
            action: 'submitQuiz',
            data: {
                videoId: currentVideoId,
                name: document.getElementById('traineeName').value,
                email: document.getElementById('traineeEmail').value,
                answers: answers
            }
        };

        stageQuiz.style.display = 'none';
        showResult('loading');
        stageResult.style.display = 'block';

        try {
            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify(payload)
            });
            const result = await response.json();
            
            if (result.status === 'success') {
                showResult('success', result.message);
            } else {
                showResult('fail', result.message);
            }
        } catch(e) {
            showResult('fail', 'เกิดข้อผิดพลาดในการเชื่อมต่อกับเซิร์ฟเวอร์');
        }
    });
    
    function showResult(type, message = '') {
        const iconEl = document.getElementById('result-icon');
        const titleEl = document.getElementById('result-title');
        const messageEl = document.getElementById('result-message');

        if (type === 'loading') {
            iconEl.innerHTML = `<i class="fas fa-spinner fa-spin text-blue-500"></i>`;
            titleEl.textContent = 'กำลังประมวลผล...';
            messageEl.textContent = 'กรุณารอสักครู่';
        } else if (type === 'success') {
            iconEl.innerHTML = `<i class="fas fa-check-circle text-green-500"></i>`;
            titleEl.textContent = 'ยินดีด้วย!';
            messageEl.textContent = message;
        } else {
            iconEl.innerHTML = `<i class="fas fa-times-circle text-red-500"></i>`;
            titleEl.textContent = 'พยายามอีกครั้ง';
            messageEl.textContent = message;
        }
    }
    
    // Initialize the main app
    App.init();
});
    </script>
</body>
</html>
